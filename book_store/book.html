<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BookHaven - Book Page</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'sans-serif';
      background-color: #f4f4f4;
      color: #000;
    }

    a:link { color: navy; text-decoration: none; }
    a:visited { color: purple; }
    a:hover { color: red; text-decoration: underline; }
    a:active { color: green; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: white;
      padding: 20px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      position: fixed;
      top: 0;
      width: 100%;
      box-sizing: border-box;
      z-index: 1000;
    }

    .container {
      max-width: 1000px;
      margin: 140px auto 40px;
      padding: 20px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .book-cover {
      max-width: 300px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    .book-cover:hover {
      transform: scale(1.03);
    }

    /* Stepper Styles from home.html */
    .stepper-container { display: flex; flex-direction: column; align-items: flex-start; }
    .quantity-stepper { display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
    .quantity-btn { background: #f0f0f0; border: none; font-size: 18px; font-weight: bold; cursor: pointer; padding: 8px 14px; color: #333; }
    .quantity-btn:disabled { color: #ccc; cursor: not-allowed; background: #f9f9f9; }
    .quantity-value { padding: 0 18px; font-size: 16px; font-weight: bold; }
    .stock-alert { font-size: 12px; color: #d9534f; text-align: center; margin-top: 5px; height: 14px; }
    .add-to-cart-btn { padding: 10px 16px; background: black; color: white; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
    .add-to-cart-btn:disabled { background: #cccccc; color: #666666; cursor: not-allowed; }

    /* Details Toggle Button */
    .details-btn { padding: 10px 16px; background: #e7e7e7; color: #333; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    
    /* Image Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        margin: auto;
        display: block;
        max-width: 80%;
        max-height: 80vh;
    }
    .modal-close {
        position: absolute;
        top: 20px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
    }
    
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 34px;
      margin-bottom: 10px;
    }

    .book-info p {
      font-size: 16px;
      margin: 6px 0;
    }

    @media (max-width: 768px) {
      .book-cover {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div style="display:flex; align-items:center; gap:10px;width:200px;">
      <img src="https://cdn-icons-png.flaticon.com/512/29/29302.png" width="40" height="40" alt="logo"/>
      <div>
        <h1 style="margin:0; font-size:22px;">BookHaven</h1>
        <p style="margin:0; font-size:13px; color:gray;">Premium Collection</p>
      </div>
    </div>
    <div style="display:flex; gap:30px; align-items:center;">
      <a href="home.html">Home</a>
      <a href="catalogue.html">Catalogue</a>
      <a href="cart.html">Cart</a>
      <a href="login.html">Login</a>
      <a href="register.html" style="padding:10px 16px; background:black; color:white; border-radius:6px;">Register</a>
    </div>
  </nav>

  <div class="container" id="book-details">
    <h1>Loading book...</h1>
  </div>

  <div id="image-modal" class="modal-overlay">
      <span class="modal-close" id="modal-close-btn">×</span>
      <img class="modal-content" id="modal-image">
  </div>
  
  <div style="background:#000000; color:white; padding:40px 20px; margin-top:60px;">
    <div style="max-width:1000px; margin:auto;">
      <h2 style="font-family:'Playfair Display',serif; font-size:26px; margin-bottom:10px;">About BookHaven</h2>
      <p style="font-size:16px; line-height:1.6; color:#ccc;">
        Welcome to BookHaven — your premium online bookstore. We offer a wide range of titles to fuel your imagination and support your learning journey. Dive into a world of stories, knowledge, and discovery curated just for you. Watch the video to learn more about our mission and values.
      </p>
      <div style="position:relative; padding-bottom:56.25%; height:0; margin-top:20px; box-shadow:0 0 20px #000;">
        <iframe 
          src="https://www.youtube.com/embed/SKVcQnyEIT8?si=Bwwi76txpvbXrzCe" 
          title="YouTube video player" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          referrerpolicy="strict-origin-when-cross-origin" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%;">
        </iframe>
      </div>
    </div>
  </div>

  <script>
    // --- CART STATE & LOGIC ---
    let cart = JSON.parse(localStorage.getItem('bookCart')) || [];
    
    function saveCart() {
        localStorage.setItem('bookCart', JSON.stringify(cart));
    }

    function handleAddToCart(book) {
        if (book && book.quantity > 0) {
            cart.push({ book: book, quantity: 1 });
            rerenderPage();
        }
    }

    function handleIncreaseQuantity(bookTitle) {
        const cartItem = cart.find(item => item.book.title === bookTitle);
        const book = getQueryParams();
        if (cartItem && cartItem.quantity < book.quantity) {
            cartItem.quantity++;
            rerenderPage();
        }
    }

    function handleDecreaseQuantity(bookTitle) {
        const cartItemIndex = cart.findIndex(item => item.book.title === bookTitle);
        if (cartItemIndex > -1) {
            cart[cartItemIndex].quantity--;
            if (cart[cartItemIndex].quantity === 0) {
                cart.splice(cartItemIndex, 1);
            }
            rerenderPage();
        }
    }

    function rerenderPage() {
        saveCart();
        const bookData = getQueryParams();
        if (bookData.title) {
            renderBook(bookData);
        }
    }

    // --- PAGE SETUP & RENDERING ---
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        title: decodeURIComponent(params.get("title")),
        author: decodeURIComponent(params.get("author")),
        category: decodeURIComponent(params.get("category")),
        price: parseFloat(params.get("price")),
        rating: parseFloat(params.get("rating")),
        quantity: parseInt(params.get("quantity"), 10),
        image: decodeURIComponent(params.get("image"))
      };
    }

    function renderBook(data) {
      const container = document.getElementById("book-details");
      const cartItem = cart.find(item => item.book.title === data.title);
      const isInCart = !!cartItem;
      let buttonHtml;
      let stockMessage = '';

      if (isInCart) {
          const currentQty = cartItem.quantity;
          const maxQtyReached = currentQty >= data.quantity;
          if (maxQtyReached) {
            stockMessage = `Only ${data.quantity} left!`;
          }
          buttonHtml = `
            <div class="stepper-container">
              <div class="quantity-stepper">
                <button class="quantity-btn" data-action="decrease" data-title="${data.title}">-</button>
                <span class="quantity-value">${currentQty}</span>
                <button class="quantity-btn" data-action="increase" data-title="${data.title}" ${maxQtyReached ? 'disabled' : ''}>+</button>
              </div>
              <div class="stock-alert">${stockMessage}</div>
            </div>
          `;
      } else {
          const isOutOfStock = data.quantity === 0;
          buttonHtml = `<button class="add-to-cart-btn" data-action="add" ${isOutOfStock ? 'disabled' : ''}>${isOutOfStock ? 'Out of Stock' : 'Add to Cart'}</button>`;
      }

      container.innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:40px;">
          <img id="book-cover-img" class="book-cover" src="${data.image}" alt="${data.title}" />
          <div class="book-info">
            <h1>${data.title}</h1>
            <p><strong>Author:</strong> ${data.author}</p>
            <p><strong>Department:</strong> ${data.category}</p>
            <p><strong>Rating:</strong> ★ ${data.rating}</p>
            <p style="font-size: 24px; font-weight: bold; margin: 16px 0;">$${data.price}</p>
            
            <div id="book-cart-controls" style="margin-top: 20px;">
              ${buttonHtml}
            </div>

            <hr style="margin: 20px 0;">

            <button id="toggle-details-btn" class="details-btn">Show Details</button>
            <div id="book-description" style="display: none; margin-top: 10px;">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse dapibus, sem vitae dapibus laoreet, nunc eros cursus arcu, vitae interdum magna arcu sit amet nulla. Pellentesque quis semper mi. Duis vel quam sed elit fringilla finibus.</p>
            </div>
          </div>
        </div>
      `;
      
      attachEventListeners();
    }

    function attachEventListeners() {
        const cartControls = document.getElementById('book-cart-controls');
        if (cartControls) {
            cartControls.addEventListener('click', (e) => {
                const action = e.target.dataset.action;
                const title = e.target.dataset.title;
                const bookData = getQueryParams();

                if (action === 'add') handleAddToCart(bookData);
                else if (action === 'increase') handleIncreaseQuantity(title);
                else if (action === 'decrease') handleDecreaseQuantity(title);
            });
        }
        
        const toggleBtn = document.getElementById('toggle-details-btn');
        const description = document.getElementById('book-description');
        if (toggleBtn && description) {
            toggleBtn.addEventListener('click', () => {
                const isHidden = description.style.display === 'none';
                description.style.display = isHidden ? 'block' : 'none';
                toggleBtn.textContent = isHidden ? 'Hide Details' : 'Show Details';
            });
        }

        const bookCoverImg = document.getElementById('book-cover-img');
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        const closeModalBtn = document.getElementById('modal-close-btn');

        if (bookCoverImg) {
            bookCoverImg.addEventListener('click', () => {
                modal.style.display = 'flex';
                modalImg.src = bookCoverImg.src;
            });
        }
        if(closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        if(modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const bookData = getQueryParams();
        if (bookData.title) {
            // A small hack: since home.html doesn't pass quantity, we can find it
            // This would be solved by a real backend or a more robust state management
            const bookFromStorage = JSON.parse(localStorage.getItem('allBooks'))?.find(b => b.title === bookData.title);
            if(bookFromStorage) {
                bookData.quantity = bookFromStorage.quantity;
            }
            renderBook(bookData);
        } else {
            document.getElementById("book-details").innerHTML = '<h1>Book not found.</h1><p>Please select a book from our <a href="home.html">catalogue</a>.</p>';
        }
    });

  </script>

</body>
</html>